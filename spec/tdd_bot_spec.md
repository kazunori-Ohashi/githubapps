# tdd_bot.py 機能仕様・動作仕様まとめ（GitHub連携版）

---

## 概要

**tdd_bot.py** は、Discord上で動作するTDD（テスト駆動開発）思想の多機能Botです。
主にファイル（テキスト・PDF・音声・動画）を受け取り、Markdown記事や要約（TLDR）を自動生成し、Discordで配信します。

**メール送信機能は全廃し、代わりに「GitHub App連携でMDファイルを指定リポジトリにコミット」する機能に一本化します。**

---

## 主な機能一覧

### 1. Markdown記事生成（/article コマンド）
- テキスト・PDF・音声・動画ファイルからMarkdown記事を自動生成
- PREP法・PAS法の2種類のスタイルを選択可能
- TLDR（要約）を記事冒頭に付与するオプション
- ファイルサイズ制限（無料: 10MB/20MB, Premium: 50MB）
- 生成結果をDiscordに添付ファイルとして送信
- **生成した記事（.md）をGitHub App経由で指定リポジトリにコミット**

### 2. TLDR（要約）生成（/tldr コマンド）
- ファイル（テキスト・PDF・音声・動画）から要約（TLDR）を生成
- 生成結果をDiscordに送信
- **生成した要約（.md）をGitHub App経由で指定リポジトリにコミット**

### 3. Markdown整形モード（/insert コマンド）
- コマンド実行後、次の発言をMarkdown整形してファイル化
- 整形結果をDiscordに添付ファイルで送信
- **整形結果（.md）をGitHub App経由で指定リポジトリにコミット**
- 音声入力によるテキスト整形も想定

### 4. 利用回数制限（Rate Limiting）
- 無料ユーザーは日次利用回数制限（デフォルト5回/日）
- Premiumユーザーは無制限
- `/usage` で本日の残り利用回数を確認可能

### 5. ファイルサイズ制限
- 無料ユーザー: テキスト/PDFは10MB、音声/動画は20MBまで
- Premiumユーザー: すべて50MBまで

### 6. リアクションによる自動処理
- 🎤（マイク）リアクション: 音声・動画ファイルの自動文字起こし
- ❤️（ハート）リアクション: 生成記事のツイートプレビュー生成（編集UI付き）

### 7. 管理者向け統計機能
- `/rate_stats` でRate Limiting（429エラー）統計を管理者が確認可能
  - ユーザー別・コマンド別・時間帯別・直近エラー履歴など

### 8. その他
- 一時ファイルは14日間保存し、自動クリーンアップ
- 各種キャッシュ（ユーザー権限・履歴など）は永続化
- プロセスロックで多重起動防止
- 依存性チェック（ffmpeg, OpenAI, Discord Token等）

---

## 動作仕様（ワークフロー例）

### 記事生成の流れ
1. ユーザーが `/article` コマンドでファイルをアップロード
2. ファイル種別・サイズ・利用回数制限をチェック
3. ファイル内容を抽出（テキスト化）
4. OpenAI APIでMarkdown記事を生成（スタイル選択可）
5. TLDRオプションがあれば要約も生成
6. Discordに記事ファイルを送信
7. **生成した記事（.md）をGitHub App経由で指定リポジトリにコミット**
8. 生成履歴をキャッシュ

### TLDR生成の流れ
1. `/tldr` コマンドでファイルをアップロード
2. ファイル種別・サイズ・利用回数制限をチェック
3. ファイル内容を抽出（テキスト化）
4. OpenAI APIで要約を生成
5. Discordに要約を送信
6. **生成した要約（.md）をGitHub App経由で指定リポジトリにコミット**

### Markdown整形モード
1. `/insert` コマンド実行で「整形待ち受け」状態に
2. 次の発言を自動でMarkdown整形
3. 整形結果をDiscordにファイル添付で送信
4. **整形結果（.md）をGitHub App経由で指定リポジトリにコミット**

### リアクション自動処理
- 🎤: 音声・動画ファイルの文字起こしを自動で実行し、結果をファイルで返信
- ❤️: 記事のツイートプレビューを自動生成し、編集UI付きで返信
  - 文字数は `TWEET_MAX`（既定280、任意で140等）に基づき制御
  - 超過時はギルドのOpenAIキーで要約し、失敗時は安全に切り詰め
  - 投稿はintent URLでユーザーが送信（自動投稿はしない）

---

## 技術仕様・設計ポイント
- **OpenAI API**（GPT-4o-mini, Whisper）を利用した記事生成・要約・音声認識
- **pdfminer.six** でPDFテキスト抽出
- **ffmpeg** で動画→音声抽出
- **watchdog** でファイル監視（現在は未使用）
- **キャッシュ**はJSONファイル永続化＋in-memory
- **コマンドは全てSlashコマンド対応**
- **多重起動防止**のためプロセスロックを採用
- **エラーハンドリング**・**Rate Limiting**対策を徹底
- **GitHub App連携**で、生成したMarkdownファイルを指定リポジトリにコミット（Octokit等を利用）

---

## 想定ユースケース
- Discordで受け取った会議録音・動画・PDF資料を即座にMarkdown記事化
- 生成記事や要約を自動でGitHubリポジトリにコミットし、ナレッジ共有
- 音声入力やリアクション操作で手軽に文字起こし・記事化
- 利用回数制限や管理者向け統計で運用負荷を低減

---

※ご要望に応じて、各コマンドや内部処理の詳細仕様も個別にまとめられます。 
