name: Summarize (Brief)

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue number to process
        required: true
        type: number
      body_override:
        description: Optional raw text to summarize
        required: false
        type: string

permissions:
  contents: write
  issues: write

concurrency:
  group: summarize-${{ github.event.issue.number || inputs.issue_number }}-brief
  cancel-in-progress: false

jobs:
  run:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'summarize:brief')
    runs-on: ubuntu-latest
    env:
      MODEL: gpt-4o-mini
      ARTICLES_DIR: ${{ vars.ARTICLES_DIR || 'Writing' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve context
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let number, title, body;
            if (context.eventName === 'workflow_dispatch') {
              number = Number(core.getInput('issue_number'));
              const res = await github.rest.issues.get({ owner, repo, issue_number: number });
              title = res.data.title || `issue-${number}`;
              const override = core.getInput('body_override');
              body = override || res.data.body || '';
            } else {
              number = context.payload.issue.number;
              title = context.payload.issue.title || `issue-${number}`;
              body = context.payload.issue.body || '';
            }
            core.setOutput('owner', owner);
            core.setOutput('repo', repo);
            core.setOutput('number', String(number));
            core.setOutput('title', title);
            core.setOutput('body', body);

      - name: Generate brief summary (OpenAI)
        id: ai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL: ${{ env.MODEL }}
          INPUT_TEXT: ${{ steps.ctx.outputs.body }}
        run: |
          set -euo pipefail
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "Missing OPENAI_API_KEY" >&2
            exit 1
          fi
          read -r -d '' SYSTEM << 'SYS' || true
          あなたは日本語の要約アシスタントです。重要点のみ3〜6行で簡潔にまとめてください。箇条書き可。固有名詞と数値は保持。余計な前置きは不要。
          SYS
          read -r -d '' USER << 'USR' || true
          次の本文を要約してください。
          ---
          ${INPUT_TEXT}
          USR
          BODY=$(jq -n --arg s "$SYSTEM" --arg u "$USER" '{
            model: env.MODEL,
            messages: [ {role:"system", content:$s}, {role:"user", content:$u} ],
            temperature: 0.3
          }')
          RESP=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" -d "$BODY")
          SUMMARY=$(echo "$RESP" | jq -r '.choices[0].message.content // empty')
          if [ -z "$SUMMARY" ]; then echo "$RESP" >&2; exit 1; fi
          echo "summary<<EOF" >> "$GITHUB_OUTPUT"; echo "$SUMMARY" >> "$GITHUB_OUTPUT"; echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Compose file and commit
        env:
          DIR: ${{ env.ARTICLES_DIR }}
          TITLE: ${{ steps.ctx.outputs.title }}
          NUM: ${{ steps.ctx.outputs.number }}
          SUMMARY: ${{ steps.ai.outputs.summary }}
        run: |
          set -euo pipefail
          slug() { echo "$1" | tr ' ' '-' | sed -E 's/[^A-Za-z0-9._-]+//g' | sed -E 's/^-+|-+$//g'; }
          base=$(slug "$TITLE"); if [ -z "$base" ]; then base="issue-${NUM}"; fi
          mkdir -p "$DIR"
          file="$DIR/${base}-summary.md"
          printf "%s\n\n%s\n" "# Summary: $TITLE" "$SUMMARY" > "$file"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$file"
          git commit -m "docs: brief summary for issue #$NUM" || echo "No changes to commit"
          git push

      - name: Comment summary on issue
        uses: actions/github-script@v7
        env:
          SUMMARY: ${{ steps.ai.outputs.summary }}
        with:
          script: |
            await github.rest.issues.createComment({
              owner: '${{ steps.ctx.outputs.owner }}',
              repo: '${{ steps.ctx.outputs.repo }}',
              issue_number: Number('${{ steps.ctx.outputs.number }}'),
              body: '📝 要約（簡潔版）\n\n' + process.env.SUMMARY
            });

